#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

bashio::log.info "Starting Period Predictor service"

# Determine the port: prefer configured network port, then ingress, else default
PORT="$(bashio::addon.port 3002/tcp 2>/dev/null)"
if ! bashio::var.has_value "${PORT}"; then
    PORT="$(bashio::addon.ingress_port 2>/dev/null)"
fi
if ! bashio::var.has_value "${PORT}"; then
    PORT="3002"
fi
export PORT
bashio::log.info "Listening on port ${PORT}"

LOG_LEVEL="$(bashio::config 'log_level' 'info')"
export LOG_LEVEL
bashio::log.info "Using log level ${LOG_LEVEL}"

OPENAI_API_KEY="$(bashio::config 'openai_api_key' '')"
if bashio::var.has_value "${OPENAI_API_KEY}"; then
    export OPENAI_API_KEY
    bashio::log.info "OpenAI API key loaded from configuration"
else
    bashio::log.info "No OpenAI API key provided"
fi

exec npm --prefix /app/backend start
